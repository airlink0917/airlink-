<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保存機能テスト</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1976D2;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>📝 保存機能テスト</h1>

    <div class="section">
        <h2>🔧 テスト準備</h2>
        <button onclick="checkConstraints()">ユニーク制約を確認</button>
        <button onclick="checkTableColumns()">テーブルカラムを確認</button>
        <div id="checkResult"></div>
    </div>

    <div class="section">
        <h2>➕ イベント作成テスト</h2>
        <label>タイトル:</label>
        <input type="text" id="eventTitle" value="テストイベント" />

        <label>日付:</label>
        <input type="date" id="eventDate" />

        <label>担当者:</label>
        <input type="text" id="eventPerson" value="テスト担当者" />

        <button onclick="testCreateEvent()">新規イベントを保存</button>
        <button onclick="testUpdateEvent()">既存イベントを更新</button>
        <div id="saveResult"></div>
    </div>

    <div class="section">
        <h2>🔍 デバッグログ</h2>
        <button onclick="clearLog()">ログをクリア</button>
        <div id="debugLog" class="log"></div>
    </div>

    <div class="section">
        <h2>🧪 自動診断</h2>
        <button onclick="runDiagnostics()">問題を自動診断</button>
        <div id="diagnosticsResult"></div>
    </div>

    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://igjkroqjhwhewtrprhds.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnamtyb3FqaHdoZXd0cnByaGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTQ5ODEsImV4cCI6MjA3MzgzMDk4MX0.7pD4mWSbr8FvGKIjkNSrQuLdUPISxayZGANZ27TuqzI';
        const USER_ID = 'global_user';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let testEventId = null;

        // ページ読み込み時に日付を今日に設定
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        });

        // ログ関数
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logEl.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // ユニーク制約を確認
        async function checkConstraints() {
            const resultEl = document.getElementById('checkResult');
            resultEl.innerHTML = '<div class="info">確認中...</div>';

            try {
                // ユニーク制約を確認
                const { data, error } = await supabase.rpc('get_table_constraints', {
                    table_name: 'schedule_events'
                }).catch(async (err) => {
                    // RPCが存在しない場合は直接SQLで確認
                    const { data: constraints, error: sqlError } = await supabase
                        .from('schedule_events')
                        .select('*')
                        .limit(0);

                    if (sqlError) throw sqlError;

                    return { data: 'RPC not available', error: null };
                });

                if (error) {
                    resultEl.innerHTML = `<div class="error">制約確認エラー: ${error.message}</div>`;
                } else {
                    resultEl.innerHTML = `<div class="success">接続成功。詳細: ${JSON.stringify(data)}</div>`;
                }

                log('制約確認完了', 'success');
            } catch (err) {
                resultEl.innerHTML = `<div class="error">エラー: ${err.message}</div>`;
                log(`制約確認エラー: ${err.message}`, 'error');
            }
        }

        // テーブルカラムを確認
        async function checkTableColumns() {
            const resultEl = document.getElementById('checkResult');
            resultEl.innerHTML = '<div class="info">確認中...</div>';

            try {
                // テーブルから1件取得してカラムを確認
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    const hasIsDeleted = columns.includes('is_deleted');

                    resultEl.innerHTML = `
                        <div class="success">
                            <strong>カラム一覧:</strong><br>
                            ${columns.join(', ')}<br><br>
                            <strong>is_deletedカラム:</strong> ${hasIsDeleted ? '✅ 存在' : '❌ 存在しない'}
                        </div>
                    `;
                    log(`カラム確認: is_deleted=${hasIsDeleted}`, 'success');
                } else {
                    resultEl.innerHTML = '<div class="info">データがありません</div>';
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">エラー: ${err.message}</div>`;
                log(`カラム確認エラー: ${err.message}`, 'error');
            }
        }

        // 新規イベント作成テスト
        async function testCreateEvent() {
            const resultEl = document.getElementById('saveResult');
            resultEl.innerHTML = '<div class="info">保存中...</div>';

            const eventId = 'test_' + Date.now();
            testEventId = eventId; // 後で更新テスト用に保持

            const eventData = {
                user_id: USER_ID,
                event_id: eventId,
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                person: document.getElementById('eventPerson').value,
                time: '10:00',
                color: '#2196F3',
                note: 'テストノート',
                is_campaign: false,
                campaign_members: [],
                is_deleted: false
            };

            log(`保存データ: ${JSON.stringify(eventData)}`);

            try {
                // 方法1: upsertを使用
                log('upsert方式で保存を試みます...');
                const { data, error } = await supabase
                    .from('schedule_events')
                    .upsert(eventData, {
                        onConflict: 'user_id,event_id'
                    })
                    .select();

                if (error) {
                    log(`upsertエラー: ${error.message}`, 'error');
                    log(`エラー詳細: ${JSON.stringify(error)}`, 'error');

                    // 方法2: insertを試す
                    log('insert方式で再試行...');
                    const { data: insertData, error: insertError } = await supabase
                        .from('schedule_events')
                        .insert(eventData)
                        .select();

                    if (insertError) {
                        log(`insertエラー: ${insertError.message}`, 'error');
                        throw insertError;
                    } else {
                        resultEl.innerHTML = `<div class="success">✅ INSERT成功！<br>ID: ${eventId}</div>`;
                        log('INSERT成功', 'success');
                    }
                } else {
                    resultEl.innerHTML = `<div class="success">✅ UPSERT成功！<br>ID: ${eventId}</div>`;
                    log(`UPSERT成功: ${JSON.stringify(data)}`, 'success');
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">❌ 保存失敗: ${err.message}</div>`;
                log(`保存失敗: ${err.message}`, 'error');
            }
        }

        // 既存イベント更新テスト
        async function testUpdateEvent() {
            if (!testEventId) {
                alert('先に新規イベントを作成してください');
                return;
            }

            const resultEl = document.getElementById('saveResult');
            resultEl.innerHTML = '<div class="info">更新中...</div>';

            const eventData = {
                user_id: USER_ID,
                event_id: testEventId,
                title: document.getElementById('eventTitle').value + ' (更新済み)',
                date: document.getElementById('eventDate').value,
                person: document.getElementById('eventPerson').value,
                time: '14:00',
                color: '#4CAF50',
                note: '更新テストノート',
                is_campaign: false,
                campaign_members: [],
                is_deleted: false
            };

            log(`更新データ: ${JSON.stringify(eventData)}`);

            try {
                // upsertで更新
                const { data, error } = await supabase
                    .from('schedule_events')
                    .upsert(eventData, {
                        onConflict: 'user_id,event_id'
                    })
                    .select();

                if (error) {
                    log(`更新エラー: ${error.message}`, 'error');
                    throw error;
                } else {
                    resultEl.innerHTML = `<div class="success">✅ 更新成功！<br>ID: ${testEventId}</div>`;
                    log(`更新成功: ${JSON.stringify(data)}`, 'success');
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">❌ 更新失敗: ${err.message}</div>`;
                log(`更新失敗: ${err.message}`, 'error');
            }
        }

        // 自動診断
        async function runDiagnostics() {
            const resultEl = document.getElementById('diagnosticsResult');
            resultEl.innerHTML = '<div class="info">診断中...</div>';

            const issues = [];
            const solutions = [];

            try {
                // 1. テーブル存在確認
                log('診断1: テーブル存在確認...');
                const { error: tableError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                if (tableError) {
                    issues.push('テーブルへのアクセスエラー');
                    solutions.push('Supabaseの権限設定を確認');
                }

                // 2. is_deletedカラム確認
                log('診断2: is_deletedカラム確認...');
                const { data: columnData } = await supabase
                    .from('schedule_events')
                    .select('is_deleted')
                    .limit(1);

                if (columnData === null) {
                    issues.push('is_deletedカラムが存在しない可能性');
                    solutions.push('SQLマイグレーションを実行');
                }

                // 3. upsert制約テスト
                log('診断3: upsert制約テスト...');
                const testId = 'diagnostic_' + Date.now();
                const { error: upsertError } = await supabase
                    .from('schedule_events')
                    .upsert({
                        user_id: USER_ID,
                        event_id: testId,
                        title: '診断テスト',
                        date: new Date().toISOString().split('T')[0],
                        is_deleted: false
                    }, {
                        onConflict: 'user_id,event_id'
                    });

                if (upsertError) {
                    if (upsertError.message.includes('unique') || upsertError.message.includes('conflict')) {
                        issues.push('ユニーク制約が設定されていない');
                        solutions.push('fix_upsert_constraint.sqlを実行');
                    } else {
                        issues.push(`upsertエラー: ${upsertError.message}`);
                    }
                }

                // 4. 削除（クリーンアップ）
                await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('event_id', testId);

                // 結果表示
                if (issues.length === 0) {
                    resultEl.innerHTML = `
                        <div class="success">
                            <strong>✅ 問題は見つかりませんでした</strong><br>
                            保存機能は正常に動作するはずです。
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="error">
                            <strong>⚠️ 問題が見つかりました:</strong><br>
                            <ul>
                                ${issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                            <strong>推奨される解決策:</strong><br>
                            <ul>
                                ${solutions.map(sol => `<li>${sol}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                log('診断完了', 'success');
            } catch (err) {
                resultEl.innerHTML = `<div class="error">診断エラー: ${err.message}</div>`;
                log(`診断エラー: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>