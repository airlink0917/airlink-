<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å­˜æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1976D2;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ ä¿å­˜æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>

    <div class="section">
        <h2>ğŸ”§ ãƒ†ã‚¹ãƒˆæº–å‚™</h2>
        <button onclick="checkConstraints()">ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ç¢ºèª</button>
        <button onclick="checkTableColumns()">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ ã‚’ç¢ºèª</button>
        <div id="checkResult"></div>
    </div>

    <div class="section">
        <h2>â• ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ</h2>
        <label>ã‚¿ã‚¤ãƒˆãƒ«:</label>
        <input type="text" id="eventTitle" value="ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ" />

        <label>æ—¥ä»˜:</label>
        <input type="date" id="eventDate" />

        <label>æ‹…å½“è€…:</label>
        <input type="text" id="eventPerson" value="ãƒ†ã‚¹ãƒˆæ‹…å½“è€…" />

        <button onclick="testCreateEvent()">æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜</button>
        <button onclick="testUpdateEvent()">æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°</button>
        <div id="saveResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
        <div id="debugLog" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ§ª è‡ªå‹•è¨ºæ–­</h2>
        <button onclick="runDiagnostics()">å•é¡Œã‚’è‡ªå‹•è¨ºæ–­</button>
        <div id="diagnosticsResult"></div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://igjkroqjhwhewtrprhds.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnamtyb3FqaHdoZXd0cnByaGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTQ5ODEsImV4cCI6MjA3MzgzMDk4MX0.7pD4mWSbr8FvGKIjkNSrQuLdUPISxayZGANZ27TuqzI';
        const USER_ID = 'global_user';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let testEventId = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        });

        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logEl.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ç¢ºèª
        async function checkConstraints() {
            const resultEl = document.getElementById('checkResult');
            resultEl.innerHTML = '<div class="info">ç¢ºèªä¸­...</div>';

            try {
                // ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ç¢ºèª
                const { data, error } = await supabase.rpc('get_table_constraints', {
                    table_name: 'schedule_events'
                }).catch(async (err) => {
                    // RPCãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç›´æ¥SQLã§ç¢ºèª
                    const { data: constraints, error: sqlError } = await supabase
                        .from('schedule_events')
                        .select('*')
                        .limit(0);

                    if (sqlError) throw sqlError;

                    return { data: 'RPC not available', error: null };
                });

                if (error) {
                    resultEl.innerHTML = `<div class="error">åˆ¶ç´„ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                } else {
                    resultEl.innerHTML = `<div class="success">æ¥ç¶šæˆåŠŸã€‚è©³ç´°: ${JSON.stringify(data)}</div>`;
                }

                log('åˆ¶ç´„ç¢ºèªå®Œäº†', 'success');
            } catch (err) {
                resultEl.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
                log(`åˆ¶ç´„ç¢ºèªã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ ã‚’ç¢ºèª
        async function checkTableColumns() {
            const resultEl = document.getElementById('checkResult');
            resultEl.innerHTML = '<div class="info">ç¢ºèªä¸­...</div>';

            try {
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰1ä»¶å–å¾—ã—ã¦ã‚«ãƒ©ãƒ ã‚’ç¢ºèª
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    const hasIsDeleted = columns.includes('is_deleted');

                    resultEl.innerHTML = `
                        <div class="success">
                            <strong>ã‚«ãƒ©ãƒ ä¸€è¦§:</strong><br>
                            ${columns.join(', ')}<br><br>
                            <strong>is_deletedã‚«ãƒ©ãƒ :</strong> ${hasIsDeleted ? 'âœ… å­˜åœ¨' : 'âŒ å­˜åœ¨ã—ãªã„'}
                        </div>
                    `;
                    log(`ã‚«ãƒ©ãƒ ç¢ºèª: is_deleted=${hasIsDeleted}`, 'success');
                } else {
                    resultEl.innerHTML = '<div class="info">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
                log(`ã‚«ãƒ©ãƒ ç¢ºèªã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ
        async function testCreateEvent() {
            const resultEl = document.getElementById('saveResult');
            resultEl.innerHTML = '<div class="info">ä¿å­˜ä¸­...</div>';

            const eventId = 'test_' + Date.now();
            testEventId = eventId; // å¾Œã§æ›´æ–°ãƒ†ã‚¹ãƒˆç”¨ã«ä¿æŒ

            const eventData = {
                user_id: USER_ID,
                event_id: eventId,
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                person: document.getElementById('eventPerson').value,
                time: '10:00',
                color: '#2196F3',
                note: 'ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒˆ',
                is_campaign: false,
                campaign_members: [],
                is_deleted: false
            };

            log(`ä¿å­˜ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(eventData)}`);

            try {
                // æ–¹æ³•1: upsertã‚’ä½¿ç”¨
                log('upsertæ–¹å¼ã§ä¿å­˜ã‚’è©¦ã¿ã¾ã™...');
                const { data, error } = await supabase
                    .from('schedule_events')
                    .upsert(eventData, {
                        onConflict: 'user_id,event_id'
                    })
                    .select();

                if (error) {
                    log(`upsertã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    log(`ã‚¨ãƒ©ãƒ¼è©³ç´°: ${JSON.stringify(error)}`, 'error');

                    // æ–¹æ³•2: insertã‚’è©¦ã™
                    log('insertæ–¹å¼ã§å†è©¦è¡Œ...');
                    const { data: insertData, error: insertError } = await supabase
                        .from('schedule_events')
                        .insert(eventData)
                        .select();

                    if (insertError) {
                        log(`insertã‚¨ãƒ©ãƒ¼: ${insertError.message}`, 'error');
                        throw insertError;
                    } else {
                        resultEl.innerHTML = `<div class="success">âœ… INSERTæˆåŠŸï¼<br>ID: ${eventId}</div>`;
                        log('INSERTæˆåŠŸ', 'success');
                    }
                } else {
                    resultEl.innerHTML = `<div class="success">âœ… UPSERTæˆåŠŸï¼<br>ID: ${eventId}</div>`;
                    log(`UPSERTæˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">âŒ ä¿å­˜å¤±æ•—: ${err.message}</div>`;
                log(`ä¿å­˜å¤±æ•—: ${err.message}`, 'error');
            }
        }

        // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ãƒ†ã‚¹ãƒˆ
        async function testUpdateEvent() {
            if (!testEventId) {
                alert('å…ˆã«æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            const resultEl = document.getElementById('saveResult');
            resultEl.innerHTML = '<div class="info">æ›´æ–°ä¸­...</div>';

            const eventData = {
                user_id: USER_ID,
                event_id: testEventId,
                title: document.getElementById('eventTitle').value + ' (æ›´æ–°æ¸ˆã¿)',
                date: document.getElementById('eventDate').value,
                person: document.getElementById('eventPerson').value,
                time: '14:00',
                color: '#4CAF50',
                note: 'æ›´æ–°ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒˆ',
                is_campaign: false,
                campaign_members: [],
                is_deleted: false
            };

            log(`æ›´æ–°ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(eventData)}`);

            try {
                // upsertã§æ›´æ–°
                const { data, error } = await supabase
                    .from('schedule_events')
                    .upsert(eventData, {
                        onConflict: 'user_id,event_id'
                    })
                    .select();

                if (error) {
                    log(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    throw error;
                } else {
                    resultEl.innerHTML = `<div class="success">âœ… æ›´æ–°æˆåŠŸï¼<br>ID: ${testEventId}</div>`;
                    log(`æ›´æ–°æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                }
            } catch (err) {
                resultEl.innerHTML = `<div class="error">âŒ æ›´æ–°å¤±æ•—: ${err.message}</div>`;
                log(`æ›´æ–°å¤±æ•—: ${err.message}`, 'error');
            }
        }

        // è‡ªå‹•è¨ºæ–­
        async function runDiagnostics() {
            const resultEl = document.getElementById('diagnosticsResult');
            resultEl.innerHTML = '<div class="info">è¨ºæ–­ä¸­...</div>';

            const issues = [];
            const solutions = [];

            try {
                // 1. ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
                log('è¨ºæ–­1: ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª...');
                const { error: tableError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                if (tableError) {
                    issues.push('ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼');
                    solutions.push('Supabaseã®æ¨©é™è¨­å®šã‚’ç¢ºèª');
                }

                // 2. is_deletedã‚«ãƒ©ãƒ ç¢ºèª
                log('è¨ºæ–­2: is_deletedã‚«ãƒ©ãƒ ç¢ºèª...');
                const { data: columnData } = await supabase
                    .from('schedule_events')
                    .select('is_deleted')
                    .limit(1);

                if (columnData === null) {
                    issues.push('is_deletedã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§');
                    solutions.push('SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ');
                }

                // 3. upsertåˆ¶ç´„ãƒ†ã‚¹ãƒˆ
                log('è¨ºæ–­3: upsertåˆ¶ç´„ãƒ†ã‚¹ãƒˆ...');
                const testId = 'diagnostic_' + Date.now();
                const { error: upsertError } = await supabase
                    .from('schedule_events')
                    .upsert({
                        user_id: USER_ID,
                        event_id: testId,
                        title: 'è¨ºæ–­ãƒ†ã‚¹ãƒˆ',
                        date: new Date().toISOString().split('T')[0],
                        is_deleted: false
                    }, {
                        onConflict: 'user_id,event_id'
                    });

                if (upsertError) {
                    if (upsertError.message.includes('unique') || upsertError.message.includes('conflict')) {
                        issues.push('ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„');
                        solutions.push('fix_upsert_constraint.sqlã‚’å®Ÿè¡Œ');
                    } else {
                        issues.push(`upsertã‚¨ãƒ©ãƒ¼: ${upsertError.message}`);
                    }
                }

                // 4. å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
                await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('event_id', testId);

                // çµæœè¡¨ç¤º
                if (issues.length === 0) {
                    resultEl.innerHTML = `
                        <div class="success">
                            <strong>âœ… å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</strong><br>
                            ä¿å­˜æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="error">
                            <strong>âš ï¸ å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:</strong><br>
                            <ul>
                                ${issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                            <strong>æ¨å¥¨ã•ã‚Œã‚‹è§£æ±ºç­–:</strong><br>
                            <ul>
                                ${solutions.map(sol => `<li>${sol}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                log('è¨ºæ–­å®Œäº†', 'success');
            } catch (err) {
                resultEl.innerHTML = `<div class="error">è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
                log(`è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>