<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«–ç†å‰Šé™¤ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.delete {
            background: #f44336;
        }
        button.delete:hover {
            background: #da190b;
        }
        .event-list {
            margin-top: 10px;
        }
        .event-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .event-item.deleted {
            background: #ffebee;
            border-left-color: #f44336;
            opacity: 0.6;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-results {
            margin-top: 20px;
        }
        .test-result {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .test-result.pass {
            background: #d4edda;
            color: #155724;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ è«–ç†å‰Šé™¤ï¼ˆis_deletedï¼‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>

    <div class="section">
        <h2>ğŸ”§ ãƒ†ã‚¹ãƒˆæº–å‚™</h2>
        <button onclick="initializeTest()">ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–</button>
        <button onclick="checkDatabase()">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã‚’ç¢ºèª</button>
        <div id="initStatus"></div>
    </div>

    <div class="section">
        <h2>â• ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ</h2>
        <button onclick="createTestEvent()">ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</button>
        <button onclick="createMultipleEvents()">è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€æ‹¬ä½œæˆ</button>
        <div id="createStatus"></div>
    </div>

    <div class="section">
        <h2>ğŸ—‘ï¸ å‰Šé™¤ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testLogicalDelete()">è«–ç†å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
        <button onclick="testPhysicalDelete()" class="delete">ç‰©ç†å‰Šé™¤ã‚’å®Ÿè¡Œï¼ˆæ¯”è¼ƒç”¨ï¼‰</button>
        <div id="deleteStatus"></div>
    </div>

    <div class="section">
        <h2>ğŸ”„ åŒæœŸãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testSync()">åŒæœŸå‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testSyncWithDeleted()">å‰Šé™¤æ¸ˆã¿ã‚’å«ã‚ã¦åŒæœŸ</button>
        <div id="syncStatus"></div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
        <button onclick="loadEvents()">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’æ›´æ–°</button>
        <button onclick="loadAllEvents()">å‰Šé™¤æ¸ˆã¿ã‚‚å«ã‚ã¦è¡¨ç¤º</button>
        <div id="eventList" class="event-list"></div>
    </div>

    <div class="section">
        <h2>ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <button onclick="runAllTests()">ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
        <div id="testResults" class="test-results"></div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://igjkroqjhwhewtrprhds.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnamtyb3FqaHdoZXd0cnByaGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTQ5ODEsImV4cCI6MjA3MzgzMDk4MX0.7pD4mWSbr8FvGKIjkNSrQuLdUPISxayZGANZ27TuqzI';
        const USER_ID = 'test_user_' + Date.now(); // ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let testEvents = [];

        // åˆæœŸåŒ–
        async function initializeTest() {
            showStatus('initStatus', 'åˆæœŸåŒ–ä¸­...', 'info');

            try {
                // ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                const { error } = await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('user_id', USER_ID);

                if (error) throw error;

                showStatus('initStatus', `ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸï¼ˆUSER_ID: ${USER_ID}ï¼‰`, 'success');
                loadEvents();
            } catch (error) {
                showStatus('initStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
        async function checkDatabase() {
            showStatus('initStatus', 'ç¢ºèªä¸­...', 'info');

            try {
                // ã‚«ãƒ©ãƒ ã®å­˜åœ¨ç¢ºèª
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                const hasIsDeleted = data.length > 0 ? 'is_deleted' in data[0] : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                showStatus('initStatus',
                    `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹:\n- is_deletedã‚«ãƒ©ãƒ : ${hasIsDeleted}\n- ãƒ†ãƒ¼ãƒ–ãƒ«æ¥ç¶š: æ­£å¸¸`,
                    'success');
            } catch (error) {
                showStatus('initStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        async function createTestEvent() {
            const eventId = 'test_' + Date.now();
            const eventData = {
                user_id: USER_ID,
                event_id: eventId,
                title: 'ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ ' + new Date().toLocaleTimeString(),
                date: new Date().toISOString().split('T')[0],
                time: '10:00',
                person: 'ãƒ†ã‚¹ãƒˆæ‹…å½“è€…',
                color: '#4CAF50',
                note: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã§ã™',
                is_campaign: false,
                campaign_members: [],
                is_deleted: false
            };

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .insert(eventData)
                    .select();

                if (error) throw error;

                showStatus('createStatus', `ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆID: ${eventId}ï¼‰`, 'success');
                loadEvents();
            } catch (error) {
                showStatus('createStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        async function createMultipleEvents() {
            const events = [];
            for (let i = 0; i < 5; i++) {
                events.push({
                    user_id: USER_ID,
                    event_id: 'bulk_' + Date.now() + '_' + i,
                    title: `ã‚¤ãƒ™ãƒ³ãƒˆ ${i + 1}`,
                    date: new Date().toISOString().split('T')[0],
                    time: `${10 + i}:00`,
                    person: `æ‹…å½“è€…${i + 1}`,
                    color: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'][i],
                    note: `ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ ${i + 1}`,
                    is_campaign: false,
                    campaign_members: [],
                    is_deleted: false
                });
            }

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .insert(events)
                    .select();

                if (error) throw error;

                showStatus('createStatus', `${events.length}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');
                loadEvents();
            } catch (error) {
                showStatus('createStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // è«–ç†å‰Šé™¤ãƒ†ã‚¹ãƒˆ
        async function testLogicalDelete() {
            try {
                // æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const { data: events, error: fetchError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .eq('is_deleted', false)
                    .limit(1);

                if (fetchError) throw fetchError;

                if (!events || events.length === 0) {
                    showStatus('deleteStatus', 'å‰Šé™¤ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                const targetEvent = events[0];

                // è«–ç†å‰Šé™¤å®Ÿè¡Œ
                const { data, error } = await supabase
                    .from('schedule_events')
                    .update({ is_deleted: true })
                    .eq('event_id', targetEvent.event_id)
                    .eq('user_id', USER_ID)
                    .select();

                if (error) throw error;

                showStatus('deleteStatus',
                    `è«–ç†å‰Šé™¤æˆåŠŸ: ${targetEvent.title} (ID: ${targetEvent.event_id})`,
                    'success');
                loadEvents();
            } catch (error) {
                showStatus('deleteStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ç‰©ç†å‰Šé™¤ãƒ†ã‚¹ãƒˆï¼ˆæ¯”è¼ƒç”¨ï¼‰
        async function testPhysicalDelete() {
            if (!confirm('ç‰©ç†å‰Šé™¤ã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const { data: events, error: fetchError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .limit(1);

                if (fetchError) throw fetchError;

                if (!events || events.length === 0) {
                    showStatus('deleteStatus', 'å‰Šé™¤ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                const targetEvent = events[0];

                const { error } = await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('event_id', targetEvent.event_id)
                    .eq('user_id', USER_ID);

                if (error) throw error;

                showStatus('deleteStatus',
                    `ç‰©ç†å‰Šé™¤æˆåŠŸ: ${targetEvent.title} (ID: ${targetEvent.event_id})`,
                    'success');
                loadEvents();
            } catch (error) {
                showStatus('deleteStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // åŒæœŸãƒ†ã‚¹ãƒˆ
        async function testSync() {
            showStatus('syncStatus', 'åŒæœŸä¸­...', 'info');

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .eq('is_deleted', false); // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã ã‘

                if (error) throw error;

                testEvents = data;
                showStatus('syncStatus',
                    `åŒæœŸå®Œäº†: ${data.length}ä»¶ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—`,
                    'success');
                displayEvents(data);
            } catch (error) {
                showStatus('syncStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // å‰Šé™¤æ¸ˆã¿ã‚’å«ã‚ã¦åŒæœŸ
        async function testSyncWithDeleted() {
            showStatus('syncStatus', 'åŒæœŸä¸­ï¼ˆå‰Šé™¤æ¸ˆã¿å«ã‚€ï¼‰...', 'info');

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID);

                if (error) throw error;

                const activeCount = data.filter(e => !e.is_deleted).length;
                const deletedCount = data.filter(e => e.is_deleted).length;

                showStatus('syncStatus',
                    `åŒæœŸå®Œäº†: åˆè¨ˆ${data.length}ä»¶ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${activeCount}ä»¶ã€å‰Šé™¤æ¸ˆã¿: ${deletedCount}ä»¶ï¼‰`,
                    'success');
                displayEvents(data, true);
            } catch (error) {
                showStatus('syncStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º
        async function loadEvents() {
            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .eq('is_deleted', false)
                    .order('date', { ascending: true });

                if (error) throw error;

                displayEvents(data);
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                displayEvents([]);
            }
        }

        // ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
        async function loadAllEvents() {
            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .order('date', { ascending: true });

                if (error) throw error;

                displayEvents(data, true);
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                displayEvents([]);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
        function displayEvents(events, showDeleted = false) {
            const listEl = document.getElementById('eventList');

            if (!events || events.length === 0) {
                listEl.innerHTML = '<p>ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = events.map(event => `
                <div class="event-item ${event.is_deleted ? 'deleted' : ''}">
                    <div>
                        <strong>${event.title}</strong>
                        (${event.date} ${event.time || ''})
                        ${event.is_deleted ? ' <span style="color:red">[å‰Šé™¤æ¸ˆã¿]</span>' : ''}
                        <br>
                        <small>ID: ${event.event_id} | æ‹…å½“: ${event.person || '-'}</small>
                    </div>
                    ${!event.is_deleted ?
                        `<button onclick="deleteEvent('${event.event_id}')" class="delete">å‰Šé™¤</button>` :
                        `<button onclick="restoreEvent('${event.event_id}')">å¾©å…ƒ</button>`
                    }
                </div>
            `).join('');
        }

        // å€‹åˆ¥å‰Šé™¤
        async function deleteEvent(eventId) {
            try {
                const { error } = await supabase
                    .from('schedule_events')
                    .update({ is_deleted: true })
                    .eq('event_id', eventId)
                    .eq('user_id', USER_ID);

                if (error) throw error;

                loadEvents();
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // å¾©å…ƒ
        async function restoreEvent(eventId) {
            try {
                const { error } = await supabase
                    .from('schedule_events')
                    .update({ is_deleted: false })
                    .eq('event_id', eventId)
                    .eq('user_id', USER_ID);

                if (error) throw error;

                loadAllEvents();
            } catch (error) {
                alert('å¾©å…ƒã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // è‡ªå‹•ãƒ†ã‚¹ãƒˆ
        async function runAllTests() {
            const resultsEl = document.getElementById('testResults');
            resultsEl.innerHTML = '<h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h3>';

            const results = [];

            // ãƒ†ã‚¹ãƒˆ1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
            try {
                const { error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);
                results.push({ test: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š', pass: !error });
            } catch {
                results.push({ test: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š', pass: false });
            }

            // ãƒ†ã‚¹ãƒˆ2: ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
            try {
                const { error } = await supabase
                    .from('schedule_events')
                    .insert({
                        user_id: USER_ID,
                        event_id: 'auto_test_' + Date.now(),
                        title: 'è‡ªå‹•ãƒ†ã‚¹ãƒˆ',
                        date: new Date().toISOString().split('T')[0],
                        is_deleted: false
                    });
                results.push({ test: 'ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ', pass: !error });
            } catch {
                results.push({ test: 'ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ', pass: false });
            }

            // ãƒ†ã‚¹ãƒˆ3: è«–ç†å‰Šé™¤
            try {
                const { data: events } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .eq('is_deleted', false)
                    .limit(1);

                if (events && events.length > 0) {
                    const { error } = await supabase
                        .from('schedule_events')
                        .update({ is_deleted: true })
                        .eq('event_id', events[0].event_id);
                    results.push({ test: 'è«–ç†å‰Šé™¤', pass: !error });
                } else {
                    results.push({ test: 'è«–ç†å‰Šé™¤', pass: false });
                }
            } catch {
                results.push({ test: 'è«–ç†å‰Šé™¤', pass: false });
            }

            // ãƒ†ã‚¹ãƒˆ4: å‰Šé™¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            try {
                const { data: activeEvents } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID)
                    .eq('is_deleted', false);

                const { data: allEvents } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .eq('user_id', USER_ID);

                const hasDeleted = allEvents.some(e => e.is_deleted);
                const activeFiltered = !activeEvents.some(e => e.is_deleted);

                results.push({
                    test: 'å‰Šé™¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°',
                    pass: (!hasDeleted || activeFiltered)
                });
            } catch {
                results.push({ test: 'å‰Šé™¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°', pass: false });
            }

            // çµæœè¡¨ç¤º
            resultsEl.innerHTML = `
                <h3>ãƒ†ã‚¹ãƒˆçµæœ</h3>
                ${results.map(r => `
                    <div class="test-result ${r.pass ? 'pass' : 'fail'}">
                        ${r.pass ? 'âœ…' : 'âŒ'} ${r.test}
                    </div>
                `).join('')}
                <p style="margin-top:10px">
                    åˆè¨ˆ: ${results.length}ä»¶ |
                    æˆåŠŸ: ${results.filter(r => r.pass).length}ä»¶ |
                    å¤±æ•—: ${results.filter(r => !r.pass).length}ä»¶
                </p>
            `;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;

            if (type !== 'info') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        window.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            checkDatabase();
        });
    </script>
</body>
</html>