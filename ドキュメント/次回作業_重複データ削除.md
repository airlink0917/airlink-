# 📋 次回作業: Supabase重複データ削除とユニーク制約追加

最終更新: 2025-10-02

## 🎯 作業目的
Supabaseテーブルの重複データを削除し、ユニーク制約を追加して、upsert機能を正常に使えるようにする

## 📌 現在の状況
- ✅ **論理削除（is_deleted）実装済み**
- ✅ **保存・削除機能は正常動作中**（insert/update分岐で対応）
- ✅ **特拡保存エラーを修正**（2025-10-02）
  - upsertから insert/update分岐に変更
  - 通常のイベント保存と同じロジックを使用
- ⚠️ **重複データが存在**（確認が必要）
- ⚠️ **ユニーク制約が未設定**（user_id + event_idの組み合わせ）

## 🔧 作業手順

### Step 1: Supabase管理画面にログイン
```
URL: https://supabase.com/dashboard/project/igjkroqjhwhewtrprhds
```

### Step 2: SQL Editorを開く
左メニューの「SQL Editor」をクリック

### Step 3: SQLスクリプトを実行
`SQLファイル/cleanup_and_add_constraint.sql` の内容を順番に実行：

1. **重複データを確認**
2. **バックアップテーブルを作成**
3. **重複データを削除**（最新のIDのみ残す）
4. **ユニーク制約を追加**

各ステップの後に確認クエリを実行して、正常に処理されたことを確認してください。

### Step 4: 動作確認
1. https://airlink-schedule.vercel.app にアクセス
2. 新規イベントを作成
3. 同じイベントを編集して保存
4. 特拡を登録
5. エラーが出ないことを確認

### Step 5: 今後の方針（オプション）
ユニーク制約が追加されたら、将来的にscript.jsを以下のように最適化可能：

```javascript
// 現在: insert/update分岐
// 将来: upsertに統一可能

const { data, error } = await supabase
    .from('schedule_events')
    .upsert(eventData, {
        onConflict: 'user_id,event_id'
    })
    .select();
```

ただし、現在のinsert/update分岐も安定して動作しているため、変更は任意です。

## ⚠️ 注意事項

1. **作業前にバックアップ**
   - schedule_events_backupテーブルを作成
   - または、Supabaseのバックアップ機能を使用

2. **本番環境での作業**
   - 利用者が少ない時間帯に実施
   - 作業前後で動作確認

3. **エラーが発生した場合**
   ```sql
   -- バックアップから復元
   DROP TABLE schedule_events;
   ALTER TABLE schedule_events_backup RENAME TO schedule_events;
   ```

## 📊 期待される結果

- 重複データが削除される
- ユニーク制約が設定される
- upsert機能が正常に動作する
- パフォーマンスが向上する

## 🔍 動作確認

1. https://airlink-schedule.vercel.app で新規イベント作成
2. 同じイベントを更新
3. エラーが出ないことを確認

---

## ✅ 修正完了した項目

### 特拡登録フォームの保存エラー
**日付**: 2025-10-01 → 2025-10-02（修正完了）
**エラー内容**: 「特拡のクラウド保存に失敗しました。ローカルにのみ保存されています。」

**原因**:
- ユニーク制約が未設定のため、upsertが失敗していた
- 特拡保存処理が通常のイベント保存と異なるロジックを使用していた

**修正内容**:
- upsertから insert/update分岐に変更（script.js:1240-1292）
- 既存データの確認→存在すればupdate、なければinsertを実行
- 通常のイベント保存と同じロジックに統一

**状態**: ✅ 修正完了（動作確認は次のステップで実施）

## 📝 関連ファイル

- `SQLファイル/cleanup_and_add_constraint.sql` - 重複削除とユニーク制約追加の統合SQL（2025-10-02作成）
- `SQLファイル/fix_upsert_constraint.sql` - ユニーク制約追加SQL（参考用）
- `SQLファイル/add_is_deleted_column.sql` - 論理削除カラム追加SQL
- `script.js` - メインJavaScript（特拡保存処理を修正済み）

## 💡 メモ

現在のシステムは**重複があっても正常動作**しているため、この作業は必須ではありません。
ただし、将来的なメンテナンス性とパフォーマンス向上のため、実施することを推奨します。

---

### 作業時の連絡先
問題が発生した場合は、このファイルと現在の状況を共有してサポートを受けてください。