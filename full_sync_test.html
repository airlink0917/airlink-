<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå…¨åŒæœŸè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; text-align: center; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #e9ecef; }
        .column-check { padding: 10px; margin: 5px 0; background: #f8f9fa; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ—¥ç¨‹ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨åŒæœŸè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>

        <div class="section">
            <h2>1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®è©³ç´°ç¢ºèª</h2>
            <button onclick="checkTableStructure()">ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª</button>
            <div id="tableStructure"></div>
        </div>

        <div class="section">
            <h2>2. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ†ã‚¹ãƒˆï¼ˆå®Œå…¨ç‰ˆï¼‰</h2>
            <button onclick="testFullSave()">å®Œå…¨ãªãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
            <button onclick="loadTestData()">ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</button>
            <button class="danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
            <div id="saveTestResult"></div>
        </div>

        <div class="section">
            <h2>3. ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°è¨ºæ–­</h2>
            <button onclick="checkColumnMapping()">ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèª</button>
            <div id="columnMapping"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://igjkroqjhwhewtrprhds.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnamtyb3FqaHdoZXd0cnByaGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTQ5ODEsImV4cCI6MjA3MzgzMDk4MX0.7pD4mWSbr8FvGKIjkNSrQuLdUPISxayZGANZ27TuqzI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkTableStructure() {
            const div = document.getElementById('tableStructure');
            div.innerHTML = '<h3>ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’å–å¾—ä¸­...</h3>';

            try {
                // schedule_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã®1è¡Œã‚’å–å¾—ã—ã¦ã‚«ãƒ©ãƒ ã‚’ç¢ºèª
                const { data: sampleEvent, error: eventError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                let html = '<h3>schedule_events ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼š</h3>';

                if (eventError) {
                    html += `<p class="error">ã‚¨ãƒ©ãƒ¼: ${eventError.message}</p>`;
                } else {
                    if (sampleEvent && sampleEvent.length > 0) {
                        const columns = Object.keys(sampleEvent[0]);
                        html += '<div class="column-check"><strong>ã‚«ãƒ©ãƒ ä¸€è¦§ï¼š</strong><br>';
                        html += columns.join(', ');
                        html += '</div>';
                        html += '<pre>' + JSON.stringify(sampleEvent[0], null, 2) + '</pre>';
                    } else {
                        html += '<p class="warning">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ©ãƒ æ§‹é€ ã‚’æ¨å®šã—ã¾ã™...</p>';
                        html += '<div class="column-check">';
                        html += '<p><strong>æœŸå¾…ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ï¼ˆä½œæˆã—ãŸSQLåŸºæº–ï¼‰:</strong></p>';
                        html += '<ul>';
                        html += '<li>id (BIGSERIAL)</li>';
                        html += '<li>event_id (VARCHAR)</li>';
                        html += '<li>user_id (VARCHAR)</li>';
                        html += '<li>title (VARCHAR)</li>';
                        html += '<li>date (DATE)</li>';
                        html += '<li>time (VARCHAR)</li>';
                        html += '<li>person (VARCHAR)</li>';
                        html += '<li>description (TEXT)</li>';
                        html += '<li>color (VARCHAR)</li>';
                        html += '<li>note (TEXT)</li>';
                        html += '<li>is_campaign (BOOLEAN)</li>';
                        html += '<li>campaign_members (TEXT[])</li>';
                        html += '<li>created_at (TIMESTAMP)</li>';
                        html += '<li>updated_at (TIMESTAMP)</li>';
                        html += '</ul>';
                        html += '</div>';
                    }
                }

                // staff_membersãƒ†ãƒ¼ãƒ–ãƒ«
                const { data: sampleStaff, error: staffError } = await supabase
                    .from('staff_members')
                    .select('*')
                    .limit(1);

                html += '<h3>staff_members ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼š</h3>';

                if (staffError) {
                    html += `<p class="error">ã‚¨ãƒ©ãƒ¼: ${staffError.message}</p>`;
                } else {
                    if (sampleStaff && sampleStaff.length > 0) {
                        const columns = Object.keys(sampleStaff[0]);
                        html += '<div class="column-check"><strong>ã‚«ãƒ©ãƒ ä¸€è¦§ï¼š</strong><br>';
                        html += columns.join(', ');
                        html += '</div>';
                    } else {
                        html += '<p class="warning">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    }
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function testFullSave() {
            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...</h3>';

            const testEvent = {
                event_id: 'test_' + Date.now(),
                user_id: 'test_user',
                title: 'ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ ' + new Date().toLocaleTimeString('ja-JP'),
                date: new Date().toISOString().split('T')[0],
                time: '14:00',
                person: 'ãƒ†ã‚¹ãƒˆæ‹…å½“è€…',
                description: 'ã“ã‚Œã¯åŒæœŸãƒ†ã‚¹ãƒˆã§ã™',
                color: '#667eea',
                note: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¢',
                is_campaign: false,
                campaign_members: ['ãƒ¡ãƒ³ãƒãƒ¼1', 'ãƒ¡ãƒ³ãƒãƒ¼2']
            };

            try {
                // ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜
                const { data, error } = await supabase
                    .from('schedule_events')
                    .insert(testEvent)
                    .select();

                let html = '<h3>ä¿å­˜çµæœï¼š</h3>';

                if (error) {
                    html += `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                    html += '<p>ã‚¨ãƒ©ãƒ¼è©³ç´°:</p>';
                    html += '<pre>' + JSON.stringify(error, null, 2) + '</pre>';
                } else {
                    html += '<p class="success">âœ… ä¿å­˜æˆåŠŸï¼</p>';
                    html += '<p>ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:</p>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }

                // ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜ãƒ†ã‚¹ãƒˆ
                const testStaff = {
                    user_id: 'test_user',
                    staff_index: 0,
                    name: 'ãƒ†ã‚¹ãƒˆã‚¹ã‚¿ãƒƒãƒ• ' + Date.now()
                };

                const { data: staffData, error: staffError } = await supabase
                    .from('staff_members')
                    .upsert(testStaff, { onConflict: 'user_id,staff_index' })
                    .select();

                if (staffError) {
                    html += `<p class="error">ã‚¹ã‚¿ãƒƒãƒ•ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${staffError.message}</p>`;
                } else {
                    html += '<p class="success">âœ… ã‚¹ã‚¿ãƒƒãƒ•ä¿å­˜æˆåŠŸï¼</p>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function loadTestData() {
            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</h3>';

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                let html = '<h3>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€å¤§5ä»¶ï¼‰ï¼š</h3>';

                if (error) {
                    html += `<p class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                } else if (!data || data.length === 0) {
                    html += '<p class="warning">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    html += `<p>å–å¾—ä»¶æ•°: ${data.length}ä»¶</p>`;
                    html += '<table>';
                    html += '<tr><th>ID</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>æ—¥ä»˜</th><th>ä½œæˆæ—¥æ™‚</th></tr>';
                    data.forEach(row => {
                        html += `<tr>
                            <td>${row.id}</td>
                            <td>${row.title || '-'}</td>
                            <td>${row.date || '-'}</td>
                            <td>${row.created_at ? new Date(row.created_at).toLocaleString('ja-JP') : '-'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function clearAllData() {
            if (!confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­...</h3>';

            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤
                const { error: eventError } = await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('user_id', 'test_user');

                const { error: staffError } = await supabase
                    .from('staff_members')
                    .delete()
                    .eq('user_id', 'test_user');

                let html = '<h3>å‰Šé™¤çµæœï¼š</h3>';
                if (!eventError && !staffError) {
                    html += '<p class="success">âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</p>';
                } else {
                    html += '<p class="error">å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function checkColumnMapping() {
            const div = document.getElementById('columnMapping');
            div.innerHTML = '<h3>ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°è¨ºæ–­ä¸­...</h3>';

            let html = '<h3>JavaScriptã‚³ãƒ¼ãƒ‰ â†” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ ã®ãƒãƒƒãƒ”ãƒ³ã‚°</h3>';

            html += '<table>';
            html += '<tr><th>JSã‚³ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</th><th>DBã‚«ãƒ©ãƒ å</th><th>çŠ¶æ…‹</th></tr>';

            const mappings = [
                { js: 'event.id', db: 'id', status: 'âœ…' },
                { js: 'event.title', db: 'title', status: 'âœ…' },
                { js: 'event.date', db: 'date', status: 'âœ…' },
                { js: 'event.time', db: 'time', status: 'âœ…' },
                { js: 'event.person', db: 'person', status: 'âœ…' },
                { js: 'event.description', db: 'description', status: 'âœ…' },
                { js: 'event.color', db: 'color', status: 'âœ…' },
                { js: 'event.note', db: 'note', status: 'âœ…' },
                { js: 'event.isCampaign', db: 'is_campaign', status: 'âœ…' },
                { js: 'event.campaignMembers', db: 'campaign_members', status: 'âœ…' },
                { js: '-', db: 'event_id', status: 'âš ï¸ æœªä½¿ç”¨' },
                { js: '-', db: 'user_id', status: 'âš ï¸ æœªè¨­å®š' }
            ];

            mappings.forEach(map => {
                html += `<tr>
                    <td>${map.js}</td>
                    <td>${map.db}</td>
                    <td>${map.status}</td>
                </tr>`;
            });

            html += '</table>';

            html += '<div class="column-check">';
            html += '<h4>å•é¡Œã®å¯èƒ½æ€§:</h4>';
            html += '<ul>';
            html += '<li><strong>user_idãŒè¨­å®šã•ã‚Œã¦ã„ãªã„</strong> - å…¨ãƒ‡ãƒã‚¤ã‚¹ã§å…±é€šã®user_idã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</li>';
            html += '<li><strong>event_idãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„</strong> - é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«ä½¿ç”¨ã§ãã¾ã™</li>';
            html += '<li><strong>staff_indexã¨positionã®ä¸ä¸€è‡´</strong> - ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ³ãƒãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç¢ºèªãŒå¿…è¦</li>';
            html += '</ul>';
            html += '</div>';

            div.innerHTML = html;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.onload = function() {
            checkTableStructure();
            checkColumnMapping();
        };
    </script>
</body>
</html>