<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完全同期診断ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; text-align: center; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #e9ecef; }
        .column-check { padding: 10px; margin: 5px 0; background: #f8f9fa; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 日程システム 完全同期診断ツール</h1>

        <div class="section">
            <h2>1. テーブル構造の詳細確認</h2>
            <button onclick="checkTableStructure()">テーブル構造を確認</button>
            <div id="tableStructure"></div>
        </div>

        <div class="section">
            <h2>2. データ保存テスト（完全版）</h2>
            <button onclick="testFullSave()">完全なテストデータを保存</button>
            <button onclick="loadTestData()">保存したデータを確認</button>
            <button class="danger" onclick="clearAllData()">全データをクリア</button>
            <div id="saveTestResult"></div>
        </div>

        <div class="section">
            <h2>3. カラムマッピング診断</h2>
            <button onclick="checkColumnMapping()">カラムマッピングを確認</button>
            <div id="columnMapping"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://igjkroqjhwhewtrprhds.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnamtyb3FqaHdoZXd0cnByaGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTQ5ODEsImV4cCI6MjA3MzgzMDk4MX0.7pD4mWSbr8FvGKIjkNSrQuLdUPISxayZGANZ27TuqzI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkTableStructure() {
            const div = document.getElementById('tableStructure');
            div.innerHTML = '<h3>テーブル構造を取得中...</h3>';

            try {
                // schedule_eventsテーブルの1行を取得してカラムを確認
                const { data: sampleEvent, error: eventError } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .limit(1);

                let html = '<h3>schedule_events テーブル構造：</h3>';

                if (eventError) {
                    html += `<p class="error">エラー: ${eventError.message}</p>`;
                } else {
                    if (sampleEvent && sampleEvent.length > 0) {
                        const columns = Object.keys(sampleEvent[0]);
                        html += '<div class="column-check"><strong>カラム一覧：</strong><br>';
                        html += columns.join(', ');
                        html += '</div>';
                        html += '<pre>' + JSON.stringify(sampleEvent[0], null, 2) + '</pre>';
                    } else {
                        html += '<p class="warning">データがありません。カラム構造を推定します...</p>';
                        html += '<div class="column-check">';
                        html += '<p><strong>期待されるカラム（作成したSQL基準）:</strong></p>';
                        html += '<ul>';
                        html += '<li>id (BIGSERIAL)</li>';
                        html += '<li>event_id (VARCHAR)</li>';
                        html += '<li>user_id (VARCHAR)</li>';
                        html += '<li>title (VARCHAR)</li>';
                        html += '<li>date (DATE)</li>';
                        html += '<li>time (VARCHAR)</li>';
                        html += '<li>person (VARCHAR)</li>';
                        html += '<li>description (TEXT)</li>';
                        html += '<li>color (VARCHAR)</li>';
                        html += '<li>note (TEXT)</li>';
                        html += '<li>is_campaign (BOOLEAN)</li>';
                        html += '<li>campaign_members (TEXT[])</li>';
                        html += '<li>created_at (TIMESTAMP)</li>';
                        html += '<li>updated_at (TIMESTAMP)</li>';
                        html += '</ul>';
                        html += '</div>';
                    }
                }

                // staff_membersテーブル
                const { data: sampleStaff, error: staffError } = await supabase
                    .from('staff_members')
                    .select('*')
                    .limit(1);

                html += '<h3>staff_members テーブル構造：</h3>';

                if (staffError) {
                    html += `<p class="error">エラー: ${staffError.message}</p>`;
                } else {
                    if (sampleStaff && sampleStaff.length > 0) {
                        const columns = Object.keys(sampleStaff[0]);
                        html += '<div class="column-check"><strong>カラム一覧：</strong><br>';
                        html += columns.join(', ');
                        html += '</div>';
                    } else {
                        html += '<p class="warning">データがありません</p>';
                    }
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">エラー: ${error.message}</p>`;
            }
        }

        async function testFullSave() {
            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>テストデータ保存中...</h3>';

            const testEvent = {
                event_id: 'test_' + Date.now(),
                user_id: 'test_user',
                title: 'テストイベント ' + new Date().toLocaleTimeString('ja-JP'),
                date: new Date().toISOString().split('T')[0],
                time: '14:00',
                person: 'テスト担当者',
                description: 'これは同期テストです',
                color: '#667eea',
                note: 'テストメモ',
                is_campaign: false,
                campaign_members: ['メンバー1', 'メンバー2']
            };

            try {
                // イベント保存
                const { data, error } = await supabase
                    .from('schedule_events')
                    .insert(testEvent)
                    .select();

                let html = '<h3>保存結果：</h3>';

                if (error) {
                    html += `<p class="error">❌ エラー: ${error.message}</p>`;
                    html += '<p>エラー詳細:</p>';
                    html += '<pre>' + JSON.stringify(error, null, 2) + '</pre>';
                } else {
                    html += '<p class="success">✅ 保存成功！</p>';
                    html += '<p>保存されたデータ:</p>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }

                // スタッフメンバー保存テスト
                const testStaff = {
                    user_id: 'test_user',
                    staff_index: 0,
                    name: 'テストスタッフ ' + Date.now()
                };

                const { data: staffData, error: staffError } = await supabase
                    .from('staff_members')
                    .upsert(testStaff, { onConflict: 'user_id,staff_index' })
                    .select();

                if (staffError) {
                    html += `<p class="error">スタッフ保存エラー: ${staffError.message}</p>`;
                } else {
                    html += '<p class="success">✅ スタッフ保存成功！</p>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">❌ エラー: ${error.message}</p>`;
            }
        }

        async function loadTestData() {
            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>データ読み込み中...</h3>';

            try {
                const { data, error } = await supabase
                    .from('schedule_events')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                let html = '<h3>最新データ（最大5件）：</h3>';

                if (error) {
                    html += `<p class="error">エラー: ${error.message}</p>`;
                } else if (!data || data.length === 0) {
                    html += '<p class="warning">データがありません</p>';
                } else {
                    html += `<p>取得件数: ${data.length}件</p>`;
                    html += '<table>';
                    html += '<tr><th>ID</th><th>タイトル</th><th>日付</th><th>作成日時</th></tr>';
                    data.forEach(row => {
                        html += `<tr>
                            <td>${row.id}</td>
                            <td>${row.title || '-'}</td>
                            <td>${row.date || '-'}</td>
                            <td>${row.created_at ? new Date(row.created_at).toLocaleString('ja-JP') : '-'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">エラー: ${error.message}</p>`;
            }
        }

        async function clearAllData() {
            if (!confirm('本当にすべてのテストデータを削除しますか？')) return;

            const div = document.getElementById('saveTestResult');
            div.innerHTML = '<h3>データ削除中...</h3>';

            try {
                // テストデータのみ削除
                const { error: eventError } = await supabase
                    .from('schedule_events')
                    .delete()
                    .eq('user_id', 'test_user');

                const { error: staffError } = await supabase
                    .from('staff_members')
                    .delete()
                    .eq('user_id', 'test_user');

                let html = '<h3>削除結果：</h3>';
                if (!eventError && !staffError) {
                    html += '<p class="success">✅ テストデータを削除しました</p>';
                } else {
                    html += '<p class="error">削除エラーが発生しました</p>';
                }

                div.innerHTML = html;

            } catch (error) {
                div.innerHTML = `<p class="error">エラー: ${error.message}</p>`;
            }
        }

        async function checkColumnMapping() {
            const div = document.getElementById('columnMapping');
            div.innerHTML = '<h3>カラムマッピング診断中...</h3>';

            let html = '<h3>JavaScriptコード ↔ データベースカラムのマッピング</h3>';

            html += '<table>';
            html += '<tr><th>JSコードのプロパティ</th><th>DBカラム名</th><th>状態</th></tr>';

            const mappings = [
                { js: 'event.id', db: 'id', status: '✅' },
                { js: 'event.title', db: 'title', status: '✅' },
                { js: 'event.date', db: 'date', status: '✅' },
                { js: 'event.time', db: 'time', status: '✅' },
                { js: 'event.person', db: 'person', status: '✅' },
                { js: 'event.description', db: 'description', status: '✅' },
                { js: 'event.color', db: 'color', status: '✅' },
                { js: 'event.note', db: 'note', status: '✅' },
                { js: 'event.isCampaign', db: 'is_campaign', status: '✅' },
                { js: 'event.campaignMembers', db: 'campaign_members', status: '✅' },
                { js: '-', db: 'event_id', status: '⚠️ 未使用' },
                { js: '-', db: 'user_id', status: '⚠️ 未設定' }
            ];

            mappings.forEach(map => {
                html += `<tr>
                    <td>${map.js}</td>
                    <td>${map.db}</td>
                    <td>${map.status}</td>
                </tr>`;
            });

            html += '</table>';

            html += '<div class="column-check">';
            html += '<h4>問題の可能性:</h4>';
            html += '<ul>';
            html += '<li><strong>user_idが設定されていない</strong> - 全デバイスで共通のuser_idを使用する必要があります</li>';
            html += '<li><strong>event_idが使用されていない</strong> - 重複チェックに使用できます</li>';
            html += '<li><strong>staff_indexとpositionの不一致</strong> - スタッフメンバーテーブルで確認が必要</li>';
            html += '</ul>';
            html += '</div>';

            div.innerHTML = html;
        }

        // ページ読み込み時に自動実行
        window.onload = function() {
            checkTableStructure();
            checkColumnMapping();
        };
    </script>
</body>
</html>